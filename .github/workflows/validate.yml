name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false

      - name: Validate JSON files
        run: |
          echo "Validating marketplace.json..."
          python3 -m json.tool .claude-plugin/marketplace.json > /dev/null

          echo "Validating plugin.json files..."
          for f in plugins/*/.claude-plugin/plugin.json; do
            echo "  Checking $f"
            python3 -m json.tool "$f" > /dev/null
          done

      - name: Check marketplace consistency
        run: |
          echo "Checking all marketplace plugins have directories..."
          python3 -c "
          import json
          import os
          import sys

          with open('.claude-plugin/marketplace.json') as f:
              marketplace = json.load(f)

          errors = []
          for plugin in marketplace['plugins']:
              name = plugin['name']
              source = plugin['source']
              # source is like ./plugins/name
              path = source.lstrip('./')
              if not os.path.isdir(path):
                  errors.append(f'Plugin {name}: directory {path} not found')

              plugin_json = os.path.join(path, '.claude-plugin', 'plugin.json')
              if not os.path.isfile(plugin_json):
                  errors.append(f'Plugin {name}: missing {plugin_json}')

          if errors:
              for e in errors:
                  print(f'ERROR: {e}', file=sys.stderr)
              sys.exit(1)

          print(f'All {len(marketplace[\"plugins\"])} plugins validated')
          "

      - name: Validate SKILL.md frontmatter
        run: |
          echo "Checking SKILL.md frontmatter..."
          python3 -c "
          import os
          import re
          import sys

          errors = []
          skill_count = 0

          for root, dirs, files in os.walk('plugins'):
              for f in files:
                  if f == 'SKILL.md':
                      path = os.path.join(root, f)
                      skill_count += 1
                      with open(path) as fp:
                          content = fp.read()

                      # Check for frontmatter
                      if not content.startswith('---'):
                          errors.append(f'{path}: missing YAML frontmatter')
                          continue

                      # Extract frontmatter
                      match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
                      if not match:
                          errors.append(f'{path}: malformed frontmatter')
                          continue

                      frontmatter = match.group(1)

                      # Check for required fields
                      if 'name:' not in frontmatter:
                          errors.append(f'{path}: missing \"name\" in frontmatter')
                      if 'description:' not in frontmatter:
                          errors.append(f'{path}: missing \"description\" in frontmatter')

          if errors:
              for e in errors:
                  print(f'ERROR: {e}', file=sys.stderr)
              sys.exit(1)

          print(f'All {skill_count} SKILL.md files have valid frontmatter')
          "

      - name: Check for hardcoded paths
        run: |
          echo "Checking for hardcoded user paths..."
          if grep -rE '/home/[a-z]|/Users/[A-Z]' plugins/ --include='*.md' --include='*.py' --include='*.json' | grep -v '/path/to'; then
            echo "ERROR: Found hardcoded user paths (see above)"
            exit 1
          fi
          echo "No hardcoded user paths found"

      - name: Check for personal emails
        run: |
          echo "Checking for personal emails..."
          if grep -r '@trailofbits.com' . --include='*.json' --include='*.toml' | grep -v 'opensource@trailofbits.com' | grep -v '.git'; then
            echo "ERROR: Found personal emails (should use opensource@trailofbits.com)"
            exit 1
          fi
          echo "No personal emails found"
